# Приложение для отслеживания сна

## Обзор
Это комплексное веб-приложение для отслеживания и анализа сна, разработанное на Django. Приложение позволяет пользователям отслеживать свои режимы сна, анализировать качество сна и получать персонализированные рекомендации по улучшению гигиены сна.

## Возможности

### Управление пользователями
- Регистрация и аутентификация пользователей
- Управление профилем с персональными данными (возраст, вес, рост, пол)
- Функция сброса пароля

### Отслеживание сна
- Ручной ввод данных о сне
- Массовый импорт данных о сне из CSV-файлов
- Автоматическое определение и анализ фаз сна
- Метрики продолжительности и качества сна
- Мониторинг частоты сердечных сокращений во время сна

### Анализ сна
- Расчет эффективности сна
- Распределение фаз сна (легкий, глубокий, БДГ, бодрствование)
- Индекс фрагментации сна
- Оценка расхода калорий во время сна
- Определение хронотипа (жаворонок/сова)
- Оценка регулярности сна

### Визуализация данных
- Интерактивные графики трендов сна
- Круговые диаграммы распределения фаз сна
- Анализ вариабельности сердечного ритма
- Тренды продолжительности и эффективности сна за период

## Технический стек

### Бэкенд
- **Python 3.10+**
- **Django 4.2.11** - Веб-фреймворк
- **Celery** - Асинхронная очередь задач
- **Redis** - Брокер сообщений и кеш
- **PostgreSQL** - База данных
- **Gunicorn** - HTTP-сервер WSGI (для продакшена)

### Фронтенд
- **HTML5, CSS3, JavaScript**
- **Bootstrap 5** - Адаптивный дизайн
- **Chart.js** - Интерактивная визуализация данных
- **jQuery** - Манипуляции с DOM и AJAX

### Инструменты разработки
- **Poetry** - Управление зависимостями
- **Docker** - Контейнеризация
- **Django Debug Toolbar** - Отладка в процессе разработки
- **Black** - Форматирование кода
- **isort** - Сортировка импортов

## Структура проекта

```
sleepproject/
├── .github/                  # Конфигурации и рабочие процессы GitHub
├── .ollama_data/             # Данные и конфигурации моделей Ollama
├── grafana/                  # Дашборды и конфигурация Grafana
├── htmlcov/                  # Отчеты о покрытии тестами
├── loki/                     # Конфигурация системы логирования Loki
├── nginx/                    # Конфигурация веб-сервера Nginx
├── prometheus/               # Конфигурация мониторинга Prometheus
├── sleep_tracking_app/       # Основное приложение Django
│   ├── migrations/           # Миграции базы данных
│   ├── prompts/              # Шаблоны и конфигурации AI-промптов
│   │   ├── __init__.py
│   │   ├── baseline.py      # Базовые конфигурации промптов
│   │   └── prompts_templates.py  # Шаблоны для AI-промптов
│   ├── sleep_statistic/      # Логика анализа и статистики сна
│   ├── static/               # Статические файлы (CSS, JS, изображения)
│   ├── templates/            # HTML-шаблоны
│   ├── tests/                # Директория с тестами
│   ├── admin.py              # Конфигурация административной панели
│   ├── apps.py               # Конфигурация приложения
│   ├── csv_data_extraction.py # Утилиты импорта/экспорта CSV
│   ├── forms.py              # Определения форм
│   ├── models.py             # Модели базы данных
│   ├── tasks.py              # Асинхронные задачи Celery
│   ├── urls.py               # Маршрутизация URL
│   └── views.py              # Обработчики запросов
├── sleepproject/             # Конфигурация проекта
│   ├── __init__.py
│   ├── asgi.py              # Конфигурация ASGI
│   ├── settings.py          # Настройки Django
│   ├── urls.py             # Корневая конфигурация URL
│   └── wsgi.py             # Конфигурация WSGI
├── .env                     # Переменные окружения
├── .gitignore
├── .coverage               # Данные о покрытии тестами
├── celerybeat-schedule.*    # Файлы расписания Celery Beat
├── docker-compose.yml       # Основная конфигурация Docker Compose
├── Dockerfile               # Конфигурация Docker для веб-приложения
├── manage.py                # Скрипт управления Django
├── poetry.lock             # Файл блокировки Poetry
└── pyproject.toml          # Зависимости и конфигурация проекта
```

### Ключевые компоненты:

- **Docker & Docker Compose**: Контейнеризация и оркестрация
- **Celery**: Асинхронная очередь задач
- **Redis**: Кеширование и брокер сообщений для Celery
- **Nginx**: Веб-сервер и обратный прокси
- **Стек мониторинга**:
  - Prometheus: Сбор и мониторинг метрик
  - Grafana: Визуализация данных
  - Loki: Агрегация логов
  - Alertmanager: Управление оповещениями
- **Django**: Веб-фреймворк
- **PostgreSQL**: Основная база данных (настраивается в docker-compose)

## Модели данных

### UserData
Хранит дополнительную информацию о пользователе:
- Дата рождения
- Вес и рост
- Пол
- Уровень активности

### SleepRecord
Отслеживает отдельные сеансы сна:
- Время начала и окончания сна
- Продолжительность фаз сна (легкий, глубокий, БДГ)
- Показатели частоты сердечных сокращений
- Периоды бодрствования
- Данные с устройств

### SleepStatistics
Агрегированный анализ сна:
- Эффективность сна
- Индекс фрагментации сна
- Расход калорий
- Оценка качества сна
- Оценка влияния на здоровье

### SleepSegment
Детальное отслеживание фаз сна:
- Время начала и окончания
- Тип фазы сна (легкий, глубокий, БДГ, бодрствование)

### NightHeartRateEntry
Данные о частоте сердечных сокращений во время сна:
- Временная метка
- Ударов в минуту (BPM)

## Реализация ключевых функций

### Анализ сна
- **Эффективность сна**: Рассчитывается как (Общее время сна / Время в кровати) * 100
- **Фазы сна**: Анализируются на основе паттернов движения и частоты сердечных сокращений
- **Хронотип**: Определяется с использованием средней точки сна и паттернов продолжительности сна
- **Расход калорий**: Оценивается с использованием уравнения Миффлина-Сан Жеора, адаптированного для сна

### Импорт данных
- Поддержка массового импорта из CSV-файлов
- Асинхронная обработка данных о сне с использованием Celery
- Валидация и нормализация импортированных данных

### Оптимизация производительности
- Индексирование базы данных для частых запросов
- Кеширование вычисляемой статистики
- Асинхронная обработка задач
- Массовые операции с базой данных

## Инструкция по настройке

### Необходимые компоненты
- Python 3.10+
- PostgreSQL
- Redis
- Node.js (для фронтенд-ресурсов)

### Установка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd sleepproject
   ```

2. Настройте виртуальное окружение и установите зависимости:
   ```bash
   poetry install
   ```

3. Создайте файл `.env` с вашей конфигурацией:
   ```env
   DJANGO_SECRET_KEY=ваш-секретный-ключ
   DEBUG=True
   BD_NAME=sleep_db
   BD_USER=postgres
   BD_PASSWORD=ваш-пароль
   CELERY_BROKER_URL=
   GEMINI_API_KEY=
   GEMINI_MODEL=
   LANGFUSE_PUBLIC_KEY=
   LANGFUSE_SECRET_KEY=
   LANGFUSE_HOST=
   BASELINE_MAX_RETRIES=
   BASELINE_RETRY_DELAY=
   ```

4. Примените миграции базы данных:
   ```bash
   python manage.py migrate
   ```

5. Запустите сервер разработки:
   ```bash
   python manage.py runserver
   ```

6. Запустите Celery worker (в отдельном терминале):
   ```bash
   celery -A sleepproject worker -l info
   ```

## Использование

1. Зарегистрируйте новую учетную запись или войдите в систему
2. Заполните свой профиль персональными данными
3. Добавьте данные о сне вручную или импортируйте из CSV-файла
4. Просматривайте статистику сна и рекомендации
5. Отслеживайте свои режимы сна с течением времени

## API-эндпоинты

Приложение предоставляет REST API-эндпоинты для доступа к данным (документация доступна по адресу `/api/docs/` при локальном запуске).

## Тестирование

Запустите тесты командой:
```bash
python manage.py test
```

## Развертывание

Для продакшн-развертывания рекомендуется использовать:
- Gunicorn в качестве сервера приложений
- Nginx в качестве обратного прокси
- PostgreSQL в качестве базы данных
- Redis для кеширования и брокеринга сообщений
- Supervisor для управления процессами

## Лицензия

Этот проект лицензирован по лицензии MIT - подробности см. в файле [LICENSE](LICENSE).

## Вклад в проект

1. Сделайте форк репозитория
2. Создайте ветку для вашей функции (`git checkout -b feature/AmazingFeature`)
3. Зафиксируйте изменения (`git commit -m 'Добавлена новая функция'`)
4. Отправьте изменения в удаленный репозиторий (`git push origin feature/AmazingFeature`)
5. Создайте Pull Request

## Благодарности
- [Django](https://www.djangoproject.com/)
- [Celery](https://docs.celeryproject.org/)
- [Redis](https://redis.io/)
- [Bootstrap](https://getbootstrap.com/)
- [Chart.js](https://www.chartjs.org/)
